#!/usr/bin/env node

/**
 * Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´Ğ»Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ñ… Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
 * Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ ĞºĞ°Ğº Ğ½Ğ° Windows, Ñ‚Ğ°Ğº Ğ¸ Ğ½Ğ° Unix/Linux
 * 
 * Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:
 *   node secure-database.js           - ĞĞ´Ğ½Ğ¾ĞºÑ€Ğ°Ñ‚Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°
 *   node secure-database.js --watch   - ĞĞµĞ¿Ñ€ĞµÑ€Ñ‹Ğ²Ğ½Ñ‹Ğ¹ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³
 *   node secure-database.js --interval=5 - ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚
 */

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

const colors = {
  reset: '\x1b[0m',
  bright: '\x1b[1m',
  red: '\x1b[31m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  cyan: '\x1b[36m'
};

function log(message, color = colors.reset) {
  console.log(`${color}${message}${colors.reset}`);
}

function secureDatabase() {
  log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', colors.cyan + colors.bright);
  log('   ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ñ… Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº Ğ‘Ğ”', colors.cyan + colors.bright);
  log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n', colors.cyan + colors.bright);

  const dbPath = path.join(__dirname, '../database/college.db');

  // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
  if (!fs.existsSync(dbPath)) {
    log('âŒ Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°!', colors.red);
    log(`   ĞĞ¶Ğ¸Ğ´Ğ°ĞµÑ‚ÑÑ: ${dbPath}`, colors.red);
    log('\nĞ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ±Ğ°Ğ·Ñƒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿ĞµÑ€ĞµĞ´ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¾Ğ¹ Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°.', colors.yellow);
    process.exit(1);
  }

  log(`ğŸ“ ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ° Ğ±Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…: ${dbPath}`, colors.cyan);

  try {
    if (process.platform === 'win32') {
      // Windows: ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° ACL
      log('\nğŸ”§ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğ´Ğ»Ñ Windows...', colors.cyan);
      
      try {
        // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
        const username = process.env.USERNAME || process.env.USER;
        
        log(`   ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: ${username}`, colors.cyan);
        log('   ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°...', colors.cyan);
        
        // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ°
        log('\nğŸ“‹ Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°:', colors.yellow);
        try {
          const currentPerms = execSync(`icacls "${dbPath}"`, { encoding: 'utf8' });
          console.log(currentPerms);
        } catch (e) {
          log('   ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ°', colors.yellow);
        }
        
        log('\nâœ… Ğ’ Windows Ñ„Ğ°Ğ¹Ğ» ÑƒĞ¶Ğµ Ğ·Ğ°Ñ‰Ğ¸Ñ‰ĞµĞ½ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ¾Ğ¹ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸', colors.green);
        log('   Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ¸Ğ¼ĞµÑÑ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾:', colors.green);
        log('   - Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ', colors.green);
        log('   - ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñ‹', colors.green);
        log('   - Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ°', colors.green);
        
      } catch (error) {
        log(`\nâš ï¸  ĞŸÑ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ: ${error.message}`, colors.yellow);
        log('   Ğ’ Windows Ğ¿Ñ€Ğ°Ğ²Ğ° ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑÑÑ‚ÑÑ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ¾Ğ¹ ACL', colors.yellow);
      }
      
    } else {
      // Unix/Linux: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ chmod
      log('\nğŸ”§ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğ´Ğ»Ñ Unix/Linux...', colors.cyan);
      
      try {
        // Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ°Ğ²Ğ° 600 (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ĞµÑ† Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ñ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ/Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ)
        fs.chmodSync(dbPath, 0o600);
        
        const stats = fs.statSync(dbPath);
        const mode = (stats.mode & parseInt('777', 8)).toString(8);
        
        log(`\nâœ… ĞŸÑ€Ğ°Ğ²Ğ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹: ${mode}`, colors.green);
        log('   Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ĞµÑ† Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ñ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ/Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ² Ñ„Ğ°Ğ¹Ğ»', colors.green);
        
      } catch (error) {
        log(`\nâŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¿Ñ€Ğ°Ğ²: ${error.message}`, colors.red);
        log('   ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ: chmod 600 backend/database/college.db', colors.yellow);
        process.exit(1);
      }
    }
    
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ Ñ„Ğ°Ğ¹Ğ»Ğ°
    log('\nğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ñ„Ğ°Ğ¹Ğ»Ğ°...', colors.cyan);
    try {
      fs.accessSync(dbPath, fs.constants.R_OK | fs.constants.W_OK);
      log('âœ… Ğ¤Ğ°Ğ¹Ğ» Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ğ´Ğ»Ñ Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ Ğ¸ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸', colors.green);
    } catch (error) {
      log('âŒ ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ¾Ğ¼ Ğº Ñ„Ğ°Ğ¹Ğ»Ñƒ!', colors.red);
      process.exit(1);
    }
    
    log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', colors.green + colors.bright);
    log('   âœ¨ ĞŸÑ€Ğ°Ğ²Ğ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ñ‹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!', colors.green + colors.bright);
    log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n', colors.green + colors.bright);
    
  } catch (error) {
    log(`\nâŒ ĞĞµĞ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ½Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: ${error.message}`, colors.red);
    process.exit(1);
  }
}

// Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ°: .gitignore
function checkGitignore() {
  log('ğŸ“ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° .gitignore...', colors.cyan);
  
  const gitignorePath = path.join(__dirname, '../../.gitignore');
  
  if (!fs.existsSync(gitignorePath)) {
    log('âš ï¸  .gitignore Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½', colors.yellow);
    return;
  }
  
  const content = fs.readFileSync(gitignorePath, 'utf8');
  const hasDb = content.includes('*.db') || content.includes('.db');
  
  if (!hasDb) {
    log('âš ï¸  Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ² .gitignore!', colors.yellow);
    log('   Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ: *.db', colors.yellow);
  } else {
    log('âœ… Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ·Ğ°Ñ‰Ğ¸Ñ‰ĞµĞ½Ğ° Ğ² .gitignore', colors.green);
  }
}

// Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ: Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ†ĞµĞ»Ğ¾ÑÑ‚Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
function checkDatabaseIntegrity() {
  const dbPath = path.join(__dirname, '../database/college.db');
  
  if (!fs.existsSync(dbPath)) {
    log('âŒ Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°!', colors.red);
    return false;
  }
  
  try {
    const stats = fs.statSync(dbPath);
    const sizeInMB = (stats.size / (1024 * 1024)).toFixed(2);
    
    log(`ğŸ“Š Ğ Ğ°Ğ·Ğ¼ĞµÑ€ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…: ${sizeInMB} MB`, colors.cyan);
    
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ° Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ (Ğ¿ÑƒÑÑ‚Ğ°Ñ Ğ‘Ğ” Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ > 0)
    if (stats.size < 100) {
      log('âš ï¸  Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ¼Ğ°Ğ»Ğ° - Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¿Ğ¾Ğ²Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ°!', colors.yellow);
      return false;
    }
    
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
    const lastModified = new Date(stats.mtime);
    const now = new Date();
    const daysSinceModified = Math.floor((now - lastModified) / (1000 * 60 * 60 * 24));
    
    if (daysSinceModified > 30) {
      log(`âš ï¸  Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ÑĞ»Ğ°ÑÑŒ ${daysSinceModified} Ğ´Ğ½ĞµĞ¹`, colors.yellow);
    } else {
      log(`âœ… ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½ĞµĞµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ: ${lastModified.toLocaleString('ru-RU')}`, colors.green);
    }
    
    return true;
  } catch (error) {
    log(`âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ñ†ĞµĞ»Ğ¾ÑÑ‚Ğ½Ğ¾ÑÑ‚Ğ¸: ${error.message}`, colors.red);
    return false;
  }
}

// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ°
function startMonitoring(intervalMinutes = 10) {
  log('\nğŸ” Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…...', colors.cyan + colors.bright);
  log(`   Ğ˜Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ» Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸: ${intervalMinutes} Ğ¼Ğ¸Ğ½ÑƒÑ‚`, colors.cyan);
  log('   ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ctrl+C Ğ´Ğ»Ñ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸\n', colors.yellow);
  
  // ĞŸĞµÑ€Ğ²Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑ€Ğ°Ğ·Ñƒ
  runSecurityCheck();
  
  // ĞŸĞµÑ€Ğ¸Ğ¾Ğ´Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
  const intervalMs = intervalMinutes * 60 * 1000;
  setInterval(() => {
    log(`\n${'='.repeat(50)}`, colors.cyan);
    log(`ğŸ”„ ĞŸĞ»Ğ°Ğ½Ğ¾Ğ²Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°: ${new Date().toLocaleString('ru-RU')}`, colors.cyan);
    log('='.repeat(50), colors.cyan);
    runSecurityCheck();
  }, intervalMs);
  
  // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ¾Ğ² Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ
  process.on('SIGINT', () => {
    log('\n\nğŸ‘‹ ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼', colors.yellow);
    process.exit(0);
  });
  
  process.on('SIGTERM', () => {
    log('\n\nğŸ‘‹ ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½', colors.yellow);
    process.exit(0);
  });
}

// ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸
function runSecurityCheck() {
  try {
    secureDatabase();
    checkGitignore();
    checkDatabaseIntegrity();
    
    log('\nğŸ’¡ Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸:', colors.cyan);
    log('   1. Ğ ĞµĞ³ÑƒĞ»ÑÑ€Ğ½Ğ¾ Ğ´ĞµĞ»Ğ°Ğ¹Ñ‚Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¿Ğ¸Ğ¸ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…', colors.cyan);
    log('   2. ĞĞµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞ¹Ñ‚Ğµ Ğ±Ğ°Ğ·Ñƒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ² git', colors.cyan);
    log('   3. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…', colors.cyan);
    log('   4. Ğ ĞµĞ³ÑƒĞ»ÑÑ€Ğ½Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ğ¹Ñ‚Ğµ: node scripts/security-check.js\n', colors.cyan);
    
    return true;
  } catch (error) {
    log(`\nâŒ ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞµ: ${error.message}`, colors.red);
    return false;
  }
}

// ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ Ğ°Ñ€Ğ³ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ½Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ¾ĞºĞ¸
function parseArgs() {
  const args = process.argv.slice(2);
  const options = {
    watch: false,
    interval: 10 // ĞŸĞ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ 10 Ğ¼Ğ¸Ğ½ÑƒÑ‚
  };
  
  args.forEach(arg => {
    if (arg === '--watch' || arg === '-w') {
      options.watch = true;
    } else if (arg.startsWith('--interval=')) {
      const interval = parseInt(arg.split('=')[1]);
      if (!isNaN(interval) && interval > 0) {
        options.interval = interval;
      }
    } else if (arg === '--help' || arg === '-h') {
      printHelp();
      process.exit(0);
    }
  });
  
  return options;
}

// Ğ¡Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ¿Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
function printHelp() {
  log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', colors.cyan + colors.bright);
  log('   ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…', colors.cyan + colors.bright);
  log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n', colors.cyan + colors.bright);
  
  log('Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:', colors.cyan);
  log('  node secure-database.js [Ğ¾Ğ¿Ñ†Ğ¸Ğ¸]\n', colors.green);
  
  log('ĞĞ¿Ñ†Ğ¸Ğ¸:', colors.cyan);
  log('  --watch, -w              Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ½ĞµĞ¿Ñ€ĞµÑ€Ñ‹Ğ²Ğ½Ñ‹Ğ¹ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³', colors.green);
  log('  --interval=N             Ğ˜Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ» Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ² Ğ¼Ğ¸Ğ½ÑƒÑ‚Ğ°Ñ… (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ 10)', colors.green);
  log('  --help, -h               ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑÑ‚Ñƒ ÑĞ¿Ñ€Ğ°Ğ²ĞºÑƒ\n', colors.green);
  
  log('ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹:', colors.cyan);
  log('  node secure-database.js', colors.green);
  log('  node secure-database.js --watch', colors.green);
  log('  node secure-database.js --watch --interval=5', colors.green);
  log('  node secure-database.js --interval=15\n', colors.green);
}

// Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ
function main() {
  const options = parseArgs();
  
  if (options.watch) {
    // Ğ ĞµĞ¶Ğ¸Ğ¼ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ°
    startMonitoring(options.interval);
  } else {
    // ĞĞ´Ğ½Ğ¾ĞºÑ€Ğ°Ñ‚Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°
    runSecurityCheck();
  }
}

// Ğ—Ğ°Ğ¿ÑƒÑĞº
main();

